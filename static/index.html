<!DOCTYPE html>
<html>
<head>
	<title> My maps </title>
	<script src='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>  
	<style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>

<body>
	<div id='map'></div> 

	<script>
    var shareLocations = "";

    var wholeShareLocations = "";
  //   var shareLocations = {
  //   "type": "FeatureCollection",
  //   "features": 
  // var shareLocations = [
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 80,
  //       "cabintemp": 50,
  //       "drivertemp": 60,
  //       "Day": "Fri",
  //       "Time": "10am",
  //       "Icontype": "car",
  //       "UUID": "1"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.03472733497621,
  //         37.38877256772679
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 0,
  //       "cabintemp": 0,
  //       "drivertemp": 0,
  //       "Day": "Fri",
  //       "Time": "10am",
  //       "Icontype": "bicycle",
  //       "UUID": "2"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.037034034729,
  //         37.386901433968696
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 50,
  //       "cabintemp": 60,
  //       "drivertemp": 70,
  //       "Day": "Fri",
  //       "Time": "10am",
  //       "Icontype": "car",
  //       "UUID": "3"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.03567683696745,
  //         37.38580174815078
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 70,
  //       "cabintemp": 50,
  //       "drivertemp": 60,
  //       "Day": "Fri",
  //       "Time": "10am",
  //       "Icontype": "car",
  //       "UUID": "1"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.03356325626373,
  //         37.386164049523536
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 0,
  //       "cabintemp": 0,
  //       "drivertemp": 0,
  //       "Day": "Fri",
  //       "Time": "10am",
  //       "Icontype": "bicycle",
  //       "UUID": "4"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.03252255916595,
  //         37.386407003581105
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 70,
  //       "cabintemp": 50,
  //       "drivertemp": 60,
  //       "Day": "Fri",
  //       "Time": "11am",
  //       "Icontype": "car",
  //       "UUID": "5"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.03684091567993,
  //         37.38735323819597
  //       ]
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "properties": { 
  //       "ambienttemp": 80,
  //       "cabintemp": 50,
  //       "drivertemp": 60,
  //       "Day": "Fri",
  //       "Time": "12am",
  //       "Icontype": "car",
  //       "UUID": "6"
  //     },
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //       -122.0349794626236,
  //         37.387971267871
  //       ]
  //     }
  //   }
  //   ];
  
  // };


  var lon="-122.03455749999999", lat = "37.3871454";
  // var lon, lat;
  var position = [];
  var carCount = 0;
  var bicycleCount = 0;
  var alreadyExsist = 0;
  var ambientTempInfo = [];
  var cabinTempInfo = [];
  var driverTempInfo = [];
  var UUIDorigin = [];
  var fakeCoord = "";
  var file_points_info = "shareCoordinates.geojson"



  // $.getJSON('https://locationserver.uswest2.development.volvo.care/retrieve?search={"long":37.3871454,"lat":-122.03455749999999,"time":10,"dist":2000}', function(data) {
  //   console.log(data);
  // });
	//


  $.ajaxSetup({
    async: false
  });


  $.getJSON("shareCoordinates.geojson", function(data) {
		console.log(data); // this will show the info it in firebug console
		fakeCoord = data
	});


  /*$.getJSON('https://locationserver.uswest2.development.volvo.care/retrieve?search={"lat":'+ lat +',"lng":' + lon + ',"timespan":10,"distance":200}', function(data) {
    console.log(data);
    shareLocations = data;
  });*/

	$.getJSON('http://localhost:6060/retrieve?search={"lat":'+ lat +',"lng":' + lon + ',"timespan":10,"distance":2000}', function(data) {
		console.log(data);
		shareLocations = data;
	});


  $.ajaxSetup({
    async: true
  });


  function occurencesUUID(valueToSearch) {
    var a = [], b = [], prev, countvalue;
    
    UUIDorigin.sort();
    for ( var i = 0; i < UUIDorigin.length; i++ ) {
      if ( UUIDorigin[i] !== prev ) {
        a.push(UUIDorigin[i]);
        b.push(1);
      } else {
        b[b.length-1]++;
      }
      prev = UUIDorigin[i];
    }
      
    for ( var i = 0; i < a.length; i++ ) {
      if ( a[i] == valueToSearch ) {
        countvalue = b[i];
      }
    }
      
    return countvalue;
  }

  function display_map() {
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaWEtaTI4MyIsImEiOiJjamVqMDVxdm4zYzl5MnBsbnZhZjV1MDkyIn0.bl4Y0AewatInkbnEfTs6Pg' 

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v9',//'mapbox://styles/mapbox/satellite-streets-v10',
      center: [-121.076168,37.541611], 
      zoom: 5.6,
    });
      
    var geolocate = new mapboxgl.GeolocateControl(({
      positionOptions: {
          enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    map.addControl(geolocate);


		map.on('load', function() {

      //add fake data
      map.addLayer({
        id: 'fakeCoord',
        type: 'circle',
        source: {
          type: 'geojson',
          data: fakeCoord
        },
        paint: {
          'circle-color': [                        
            'case',
              ["<=", ['number', ['get', 'cabintemp']], 0], '#1589FF', 
              ["<=", ['number', ['get', 'cabintemp']], 50], '#F87431',//'#E18B6B',
              ["<=", ['number', ['get', 'cabintemp']], 70], '#E55451',//'#F88158',
              ["<=", ['number', ['get', 'cabintemp']], 80], '#F778A1',//'#E55B3C',
              '#893BFF'
            ],
            // '#1589FF',
          "circle-radius": 4
        }
      });

      // geolocate.trigger();
      geolocate.on('geolocate', function(e) {
        lon = e.coords.longitude;
        lat = e.coords.latitude
        position = [lon, lat];
        console.log("position = " + position);
 
        if(alreadyExsist == 0) { //seems that it execute this geolocate twice and I need to do it just once

          map.addLayer({
            id: 'shareLocationsDot',
            type: 'circle', //'symbol'
            source: {
              type: 'geojson',
              data: {
                type: "FeatureCollection",
                features: shareLocations
              }
            },
            paint: {
              'circle-color': [                        
            'case',
              ["<=", ['number', ['get', 'cabintemp']], 0], '#1589FF', 
              ["<=", ['number', ['get', 'cabintemp']], 50], '#F87431',//'#E18B6B',
              ["<=", ['number', ['get', 'cabintemp']], 70], '#E55451',//'#F88158',
              ["<=", ['number', ['get', 'cabintemp']], 80], '#F778A1',//'#E55B3C',
              '#893BFF'
            ],
              "circle-radius": 4
            }
          });
          alreadyExsist = 1;
        }
      });

      var dataLayer;

      //Trigger the API every 10 seconds
      setInterval(function(){ 
        if(map.getLayer('shareLocationsDot')){
          $.ajaxSetup({
            async: false
          });
          
          //$.getJSON('https://locationserver.uswest2.development.volvo.care/retrieve?search={"lat":37.3871454,"lng":-122.03455749999999,"timespan":10,"distance":200}', function(data) {
          $.getJSON('http://localhost:6060/retrieve?search={"lat":'+ lat +',"lng":' + lon + ',"timespan":10,"distance":2000}', function(data) {
            shareLocations = data;
            console.log(data);

            //Remove UUID duplicates 
            UUIDorigin = [];
            shareLocations.forEach(function(element,rowIndex) {
              console.log("RowIndex = " + rowIndex);
              UUIDorigin.push(element.properties['UUID'])
              console.log("UUIDorigin.length " + UUIDorigin.length); 
              console.log("UUID = " + element.properties['UUID'] + " - Occurences = " + occurencesUUID(element.properties['UUID']));
              if(occurencesUUID(element.properties['UUID']) > 1){
                shareLocations.splice(rowIndex,1)
              }
            });
            console.log(shareLocations);
            dataLayer={
                    type: "FeatureCollection",
                    features: shareLocations
                  }
          });

          $.ajaxSetup({
            async: true
          });

          //To update the map layer
          map.getSource('shareLocationsDot').setData(dataLayer);
        }
      }, 10000);


		});


    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
      });

    map.on('mouseenter', "fakeCoord", function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      var coordinates = e.features[0].geometry.coordinates.slice();
      var description = "<strong>Climate: </strong>"+e.features[0].properties.cabintemp + "<p><strong>Coordinates: </strong>"+coordinates+"</p>";  

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
    });

    map.on('mouseenter', "shareLocationsDot", function(e) {
      map.getCanvas().style.cursor = 'pointer';

      var coordinates = e.features[0].geometry.coordinates.slice();
      var description = "<strong>Climate: </strong>"+e.features[0].properties.cabintemp + "<p><strong>UUID: </strong>"+e.features[0].properties.UUID+"</p>";  

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }
      popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
    });

    map.on('mouseleave', "fakeCoord", function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });   
    map.on('mouseleave', "shareLocationsDot", function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });  
  


  }
  
	display_map();
	
	</script>

</body>
</html>	